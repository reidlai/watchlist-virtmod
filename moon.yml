# https://moonrepo.dev/docs/config/project
id: 'watchlist'
language: "unknown" # Mixed/Polyglot

fileGroups:
  go: ["go/**/*"]
  sveltekit: ["sveltekit/**/*"]
  ts: ["ts/**/*"]

tasks:
  # Go Backend
  go-build:
    command: "go build -v ./go/..."
    inputs: ["go/**/*"]
    platform: "system"

  go-test:
    command: "go test -v ./go/..."
    inputs: ["go/**/*"]
    platform: "system"

  go-lint:
    command: "go run github.com/golangci/golangci-lint/cmd/golangci-lint@latest run -v ./go/..."
    inputs: ["go/**/*"]
    platform: "system"

  go-format:
    command: "goimports -w ./go"
    inputs: ["go/**/*"]
    platform: "system"

  go-run:
    command: "cd go && go run ."
    inputs: ["go/**/*"]
    platform: "system"
    local: true

  goa-gen:
    command: "cd go && goa gen github.com/reidlai/ta-workspace/modules/watchlist/go/design"
    inputs: ["go/design/**/*"]
    platform: "system"

  # Svelte Frontend
  svelte-dev:
    command: "pnpm --dir sveltekit dev"
    local: true
    platform: "node"

  svelte-build:
    command: "pnpm --dir sveltekit build"
    inputs: ["sveltekit/**/*", "ts/**/*"]
    deps: ["ts-build"] # Depends on shared lib
    platform: "node"

  svelte-sync:
    command: "pnpm --dir sveltekit run sync"

    inputs: ["sveltekit/**/*.svelte", "sveltekit/**/*.ts", "sveltekit/**/*.js"]
    platform: "node"
    local: true
    options:
      runInCI: true # Required because 'local: true' defaults this to false
      persistent: false # It's a one-off command, not a server



  svelte-check:
    command: "pnpm --dir sveltekit check"
    inputs: ["sveltekit/**/*", "ts/**/*"]
    deps: ["svelte-sync"]
    platform: "node"


  svelte-test:
    command: "pnpm --dir sveltekit run test"
    env:
      CI: "true"
    inputs: ["sveltekit/**/*", "ts/**/*"]
    deps: ["ts-build"]
    platform: "node"

  svelte-lint:
    command: "pnpm --dir sveltekit lint"
    inputs: ["sveltekit/**/*"]
    deps: ["svelte-sync"]
    platform: "node"

  svelte-format:
    command: "pnpm --dir sveltekit run format"
    inputs: ["sveltekit/**/*"]
    platform: "node"

  svelte-storybook:
    command: "pnpm --dir sveltekit run story:dev"
    inputs: ["sveltekit/**/*"]
    platform: "node"
    local: true

  # TypeScript Shared Lib
  ts-build:
    command: "pnpm --dir ts build"
    inputs: ["ts/**/*"]
    platform: "node"

  ts-lint:
    command: "pnpm --dir ts lint"
    inputs: ["ts/**/*"]
    platform: "node"

  ts-test:
    command: "pnpm --dir ts run test"
    env:
      CI: "true"
    inputs: ["ts/**/*"]
    platform: "node"

  ts-format:
    command: "pnpm --dir ts run format"
    inputs: ["ts/**/*"]
    platform: "node"

  # Composite Tasks
  build:
    command: 'echo "Building all components"'
    deps: ["go-build", "svelte-build", "ts-build"]
    platform: "system"

  test:
    command: 'echo "Testing all components"'
    deps: ["go-test", "svelte-test", "ts-test", "svelte-check"]
    platform: "system"

  lint:
    command: 'echo "Linting all components"'
    deps: ["go-lint", "ts-lint", "svelte-lint"]
    platform: "system"

  format:
    command: 'echo "Formatting all components"'
    deps: ["go-format", "ts-format", "svelte-format"]
    platform: "system"
