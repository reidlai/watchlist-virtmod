# https://moonrepo.dev/docs/config/project
id: 'watchlist'
language: "unknown" # Mixed/Polyglot

fileGroups:
  go: ["go/**/*"]
  sveltekit: ["sveltekit/**/*", "!sveltekit/node_modules/**"]
  ts: ["ts/**/*", "!ts/node_modules/**"]

tasks:
  # Go Backend
  go-build:
    command: "go build -v ./go/..."
    inputs: ["go/**/*"]
    platform: "system"

  go-test:
    command: "go test -v ./go/..."
    inputs: ["go/**/*", "!go/goa_gen/**"]
    platform: "system"

  go-lint:
    deps: ["watchlist-go:lint"]
    platform: "system"
    options:
      mergeInputs: "replace"

  go-format:
    command: "goimports -w ./go"
    inputs: ["go/**/*"]
    options:
      mergeArgs: "replace"
      mergeInputs: "replace"

  go-run:
    command: "cd go && go run ."
    inputs: ["go/**/*"]
    platform: "system"
    local: true

  goa-gen:
    command: "cd go && goa gen github.com/reidlai/ta-workspace/modules/watchlist/go/design"
    inputs: ["go/design/**/*"]
    platform: "system"

  # Svelte Frontend
  svelte-dev:
    deps: ["watchlist-sveltekit:dev"]
    local: true
    platform: "node"

  svelte-build:
    deps: ["watchlist-sveltekit:build"]
    platform: "node"

  svelte-sync:
    deps: ["watchlist-sveltekit:sync"]
    platform: "node"
    local: true
    options:
      runInCI: true
      persistent: false

  svelte-check:
    deps: ["watchlist-sveltekit:check"]
    platform: "node"

  svelte-test:
    deps: ["watchlist-sveltekit:test"]
    platform: "node"

  svelte-lint:
    deps: ["watchlist-sveltekit:lint"]
    platform: "system"
    options:
      mergeInputs: 'replace'

  svelte-format:
    deps: ["watchlist-sveltekit:format"]
    platform: "system"
    inputs: ["moon.yml"]
    options:
      mergeInputs: 'replace'

  svelte-storybook:
    deps: ["watchlist-sveltekit:storybook"]
    platform: "node"
    local: true

  # TypeScript Shared Lib
  ts-build:
    deps: ["watchlist-ts:build"]
    platform: "node"

  ts-lint:
    deps: ["watchlist-ts:lint"]
    platform: "system"
    options:
      mergeInputs: 'replace'

  ts-test:
    deps: ["watchlist-ts:test"]
    platform: "node"

  ts-format:
    deps: ["watchlist-ts:format"]
    platform: "system"
    inputs: ["moon.yml"]
    options:
      mergeInputs: 'replace'

  # Composite Tasks
  build:
    command: 'echo "Building all components"'
    deps: ["go-build", "svelte-build", "ts-build"]
    outputs: []
    platform: "system"
    options:
      mergeInputs: 'replace'
      mergeOutputs: 'replace'

  test:
    command: 'echo "Testing all components"'
    deps: ["go-test", "svelte-test", "ts-test", "svelte-check"]
    platform: "system"

  lint:
    command: 'echo "Linting all components"'
    deps: ["go-lint", "ts-lint", "svelte-lint"]
    platform: "system"
    inputs: ["moon.yml"]
    options:
      mergeInputs: 'replace'

  format:
    command: 'echo "Formatting all components"'
    deps: ["go-format", "ts-format", "svelte-format"]
    platform: "system"
    inputs: ["moon.yml"]
    options:
      mergeInputs: 'replace'
