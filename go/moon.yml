$schema: 'https://moonrepo.dev/schemas/project.json'
id: 'watchlist-go'
type: 'library'
stack: 'backend'

tasks:
  build:
    command: 'go build ./...'
    inputs:
      - '**/*.go'
      - 'go.mod'
      - 'go.sum'
    outputs: []
    options:
      mergeOutputs: 'replace'
      mergeArgs: 'replace'

  format:
    command: "goimports"
    args:
      - "-w"
      - "."
    inputs:
      - "**/*.go"
      - "go.mod"
      - "go.sum"
      - "!**/.*/**"
    platform: "system"
    options:
      mergeArgs: "replace"
      mergeInputs: "replace"

  lint:
    command: "go"
    args:
      - "run"
      - "github.com/golangci/golangci-lint/cmd/golangci-lint@latest"
      - "run"
      - "-v"
    inputs:
      - "**/*.go"
      - "go.mod"
      - "go.sum"
      - "!**/.*/**"
    options:
      mergeArgs: "replace"
      mergeInputs: "replace"

  test:
    command: "go test ./..."
    inputs:
      - "**/*.go"
      - "go.mod"
      - "go.sum"
    options:
      runInCI: true
      mergeArgs: "replace"

  goa-gen:
    command: "goa gen github.com/reidlai/ta-workspace/modules/watchlist/go/design --output goa_gen"
    inputs:
      - "design/**/*.go"
      - "go.mod"
    outputs:
      - "goa_gen/**"
    options:
      mergeArgs: "replace"

  build-server:
    command: "go build -o bin/watchlist-server ."
    inputs:
      - "**/*.go"
      - "go.mod"
      - "go.sum"
    outputs:
      - "bin/watchlist-server"

  start:
    command: "./bin/watchlist-server"
    deps:
      - "build-server"
    local: true
